---
title: ç†è§£JSä¸­çš„å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡
emoji: ğŸ‘·
created_at: "2018-05-14"
---

æœ€è¿‘é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªé¢˜ç›®ï¼š

```jsx
console.log(1)

setTimeout(function () {
  console.log(2)
})

var promise = function () {
  return new Promise(function (resolve, reject) {
    console.log(3)
    setTimeout(function () {
      resolve(5)
    }, 0)
    console.log(4)
  })
}

promise()
  .then(function (data) {
    console.log(data)
    return Promise.resolve(6)
  })
  .then(function (data) {
    console.log(data)
  })

console.log(7)
```

è¯·é—®ä»¥ä¸Šä»£ç çš„è¾“å‡ºé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ

- ç‚¹å‡»æ­¤å¤„æŸ¥çœ‹ç­”æ¡ˆ

  ç­”æ¡ˆæ˜¯ï¼š`1`ã€`3`ã€`4`ã€`7`ã€`2`ã€`5`ã€`6`

# ä¸ºä»€ä¹ˆä¼šè¿™æ ·

å¦‚æœä½ æƒ³ç†è§£ä¸ºä»€ä¹ˆä¼šæ˜¯è¿™æ ·ï¼Œä½ éœ€è¦å¯¹ JS ä¸­çš„`Event Loop`æœ‰ä¸€ç‚¹äº†è§£ã€‚å¹¶ä¸”éœ€è¦çŸ¥é“ Event Loop æ˜¯å¦‚ä½•å¤„ç†å®ä»»åŠ¡(`macro task`)ä¸å¾®ä»»åŠ¡(`micro task`)çš„ã€‚

> Event Loop æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿ ä¸ºä»€ä¹ˆ JS éœ€è¦å®ƒï¼Ÿ

![javascript-heap-and-stack](../assets/javascript-stack-and-heap.png)

ä¸Šå›¾ä¸º Event Loop çš„å¯è§†åŒ–æ¨¡å‹å›¾ï¼ŒEvent Loop å°±æ˜¯ JS çš„è¿è¡Œæœºåˆ¶ï¼Œå®ƒçš„ä¸€å¤§ç‰¹ç‚¹å°±æ˜¯æ°¸ä¸é˜»å¡ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼ŒJS æ˜¯ä¸€é—¨å•çº¿ç¨‹çš„è¯­è¨€ï¼Œå°±æ˜¯è¯´ JS åœ¨æ‰§è¡Œä»»ä½•ä»£ç çš„æ—¶å€™ï¼Œéƒ½åªæœ‰ä¸€ä¸ªä¸»çº¿ç¨‹æ¥å¤„ç†æ‰€æœ‰çš„ä»»åŠ¡ã€‚å¦‚æœæ²¡æœ‰ Event Loopï¼Œé‚£ä¹ˆé¡µé¢åœ¨åŠ è½½å›¾ç‰‡çš„æ—¶å€™ï¼Œå°±ä¸èƒ½ç»§ç»­åŠ è½½å…¶ä»–çš„ DOM å…ƒç´ ï¼Œå¯¼è‡´ç½‘é¡µå¡é¡¿ã€‚å›¾ä¸­ Stack æŒ‡çš„æ˜¯ JS çš„è°ƒç”¨æ ˆï¼Œ Heap æ˜¯å †ï¼ŒQueue è¡¨ç¤ºé˜Ÿåˆ—ï¼Œ Event Loop ä¸€ç›´åœ¨è¿è¡Œï¼Œå¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè€Œä¸€ä¸ª Event Loop å¯ä»¥æœ‰å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ã€‚

# å®ä»»åŠ¡ä¸å¾®ä»»åŠ¡

ä¸Šé¢è¯´åˆ° Event Loop å¯ä»¥æœ‰å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰å¤šä¸ªé˜Ÿåˆ—å‘¢ï¼Ÿå› ä¸ºå¦‚æœæœ‰å¤šä¸ªé˜Ÿåˆ—çš„è¯ï¼Œå°±å¯ä»¥è®© Event Loop é€‰æ‹©æ€§çš„æ‰§è¡ŒæŸä¸ªé˜Ÿåˆ—ä¸­çš„å†…å®¹ï¼Œè¿™æ ·å°±å¯ä»¥ä¼˜å…ˆå¤„ç†æ€§èƒ½æ•æ„Ÿçš„ä»»åŠ¡ï¼Œ æ¯”å¦‚ç”¨æˆ·è¾“å…¥ã€‚
å› ä¸ºæ‰§è¡Œä¼˜å…ˆçº§çš„ä¸åŒï¼Œé‚£ä¹ˆä»»åŠ¡å°±è¢«åˆ†ä¸ºä¸¤ç±»ï¼šå®ä»»åŠ¡(`macro task`)ä¸å¾®ä»»åŠ¡(`micro task`)ã€‚

å±äºå®ä»»åŠ¡çš„æœ‰ï¼š `script(æ•´ä½“ä»£ç )`ã€`setTimeout/setInterval`ã€`I/O(ä¾‹å¦‚å›¾ç‰‡ã€è§†é¢‘çš„åŠ è½½)`ã€`UIäº¤äº’(ç”¨æˆ·çš„ç‚¹å‡»äº‹ä»¶)ä¸æ¸²æŸ“`
å±äºå¾®ä»»åŠ¡çš„æ˜¯ï¼š `process.nextTick`ã€`Promise`ã€`MutaionObserver`ã€`Object.observer`

ä¸‹å›¾ä¸ºåŸºæœ¬çš„ Event Loop è¿è¡Œè¿‡ç¨‹(å›¾ç‰‡æ¥è‡ª[çŸ¥ä¹](https://zhuanlan.zhihu.com/p/33087629))

![javascript-heap-and-stack](../assets/javascript-tasks-and-jobs.png)

Event Loop æ‰§è¡Œæ—¶ï¼Œå…ˆä»`Macrotask Queue(Task Queue)`ä¸­æ‹‰å‡ºä¸€ä¸ª task æ‰§è¡Œï¼Œ è¯¥ task æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ é¦–å…ˆæ£€æŸ¥`Microtask Queue`ä¸­æ˜¯å¦å­˜åœ¨ taskï¼Œå¦‚æœå­˜åœ¨ taskï¼Œé‚£ä¹ˆå°±ä¾æ¬¡æ‰§è¡Œ`Microtask queue`ä¸­çš„ task ç›´è‡³é˜Ÿåˆ—æ¸…ç©ºï¼Œå¦åˆ™ç»§ç»­æ‰§è¡Œ`macrotask queue`ä¸­çš„ä¸‹ä¸€ä¸ª taskã€‚æŒ‰æ­¤é¡ºåºå¾ªç¯æ‰§è¡Œã€‚

# è§‚å¯Ÿä»£ç 

çŸ¥é“äº†ä¸Šè¿°å†…å®¹ä¹‹åï¼Œå›è¿‡å¤´æ¥ç»§ç»­çœ‹æ–‡ç« å¼€å¤´çš„ä»£ç ï¼Œ åˆ†ææ‰§è¡Œé¡ºåºã€‚

```
console.log(1);

setTimeout(function () {
  console.log(2);
}, 0);

var promise = function () {
  return new Promise(function (resolve, reject) {
    console.log(3);
    setTimeout(function () {
      resolve(5);
    }, 0);
    console.log(4);
  });
};

promise()
  .then(function (data) {
    console.log(data);
    return Promise.resolve(6);
  })
  .then(function (data) {
    console.log(data);
  });

console.log(7);

```

é¦–å…ˆåœ¨ä»£ç å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå°†å…¨éƒ¨çš„ js ä»£ç æ”¾å…¥`macrotask queue`ä¸­ï¼Œ Event Loop å°† **ç¬¬ä¸€ä¸ª** macro task å‹å…¥`å…¨å±€çš„æ‰§è¡Œæ ˆ`ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥é¦–å…ˆä¼šè¾“å‡º:

> 1

ç„¶åç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œ é‡åˆ°äº†`setTimeout`, ç”±äº setTimeout å±äº`macro task`, æ‰€ä»¥åœ¨ç»è¿‡ 0ms åï¼Œå°†å›è°ƒå‡½æ•°æ¨è¿›`macrotask queue`ä¸­ï¼Œ æ­¤æ—¶`macrotask queue`å­˜åœ¨ä¸¤ä¸ªä»»åŠ¡ã€‚

> setTimeout è¿™ä¸ªå‡½æ•°ï¼Œæ˜¯ç»è¿‡æŒ‡å®šæ—¶é—´åï¼ŒæŠŠè¦æ‰§è¡Œçš„ä»»åŠ¡åŠ å…¥åˆ° macrotask queue ä¸­

ç»§ç»­æ‰§è¡Œï¼Œ åˆé‡åˆ°äº† promiseï¼Œ`new Promise` ä¸­çš„å‡½æ•°ä¼šç«‹å³æ‰§è¡Œï¼Œäºæ˜¯è¾“å‡ºäº†ï¼š

> 3

ç„¶ååˆé‡åˆ°äº†ä¸€ä¸ª setTimeoutï¼Œå°†å®ƒæ¨å…¥`macrotask queue`é˜Ÿåˆ—, æ­¤æ—¶è¯¥é˜Ÿåˆ—ä¸­å­˜åœ¨ä¸‰ä¸ªä»»åŠ¡ã€‚
ç„¶ååˆç´§æ¥ç€è¾“å‡ºäº†ï¼š

> 4

ç„¶åå†å¾€ä¸‹é‡åˆ°äº† Promise çš„ then å‡½æ•°ï¼Œä»–ä»¬å±äº`micro task`, æ‰€ä»¥å°†ä»–ä»¬æ¨å…¥`microtask queue`ä¸­ã€‚è¿™é‡Œåªæ¨å…¥äº†ç¬¬ä¸€ä¸ª thenï¼Œæ­¤æ—¶çš„`microtask queue`ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡ã€‚

ç„¶åç»§ç»­æ‰§è¡Œè¾“å‡ºäº†ï¼š

> 7

ç„¶åç¬¬ä¸€ä¸ªå®ä»»åŠ¡å°±æ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶å»æ£€æŸ¥`microtask queue`,æ­¤æ—¶çš„å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ª promise çš„ then å‡½æ•°å›è°ƒï¼Œ ä½†æ˜¯æ­¤æ—¶çš„ Promise è¿˜æ˜¯ pending çŠ¶æ€ï¼Œæ‰€ä»¥æ­¤å›è°ƒæš‚æ—¶æ— æ³•æ‰§è¡Œï¼Œ è·³è¿‡ã€‚ ç»§ç»­ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚

æ‰§è¡Œç¬¬äºŒä¸ªå®ä»»åŠ¡ï¼Œ æ­¤æ—¶è¾“å‡ºäº†ï¼š

> 2

ç»§ç»­æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ æ­¤æ—¶ Promise çš„çŠ¶æ€è¿˜æ˜¯ pendingï¼Œ ç»§ç»­ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ã€‚
æ‰§è¡Œç¬¬ä¸‰ä¸ªå®ä»»åŠ¡ï¼Œ å°† Promise çš„çŠ¶æ€æ”¹ä¸º fulfilled

æ£€æŸ¥å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ­¤æ—¶ Promise çš„çŠ¶æ€å˜ä¸º fulfilledï¼Œ æ‰§è¡Œç¬¬ä¸€ä¸ªå¾®ä»»åŠ¡
è¾“å‡ºï¼š

> 5

ç„¶åæ‰§è¡Œ Promise.resolve(6), æ‰§è¡Œ thenï¼Œå°†å›è°ƒæ¨å…¥ `microtask queue`,
ç„¶åæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œ æœ€åè¾“å‡ºï¼š

> 6

# å†™åœ¨æœ€å

é€šè¿‡æœ¬æ–‡å¯¹ JS çš„æ‰§è¡Œæœºåˆ¶æœ‰äº†ä¸€ä¸ªç®€å•çš„äº†è§£ï¼ŒçŸ¥é“äº†`å®ä»»åŠ¡`ä¸`å¾®ä»»åŠ¡`è¿™ä¸¤ä¸ªä»»åŠ¡åˆ†ç±»ï¼Œå¹¶ä¸”çŸ¥é“ Event Loop æ‰§è¡Œå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡çš„è¿‡ç¨‹ã€‚

# å‚è€ƒèµ„æ–™

1. https://jakearchibald.com/2015/tasks-microtasks-queues-and-schedules/
2. https://zhuanlan.zhihu.com/p/33058983
3. https://zhuanlan.zhihu.com/p/33087629
4. https://www.zhihu.com/question/36972010
5. https://juejin.im/post/59e85eebf265da430d571f89
